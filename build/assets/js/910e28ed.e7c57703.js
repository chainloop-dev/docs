"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[318],{3905:(t,e,n)=>{n.d(e,{Zo:()=>d,kt:()=>h});var a=n(7294);function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function s(t,e){if(null==t)return{};var n,a,i=function(t,e){if(null==t)return{};var n,a,i={},o=Object.keys(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||(i[n]=t[n]);return i}(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(a=0;a<o.length;a++)n=o[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(i[n]=t[n])}return i}var l=a.createContext({}),c=function(t){var e=a.useContext(l),n=e;return t&&(n="function"==typeof t?t(e):r(r({},e),t)),n},d=function(t){var e=c(t.components);return a.createElement(l.Provider,{value:e},t.children)},p={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},u=a.forwardRef((function(t,e){var n=t.components,i=t.mdxType,o=t.originalType,l=t.parentName,d=s(t,["components","mdxType","originalType","parentName"]),u=c(n),h=i,g=u["".concat(l,".").concat(h)]||u[h]||p[h]||o;return n?a.createElement(g,r(r({ref:e},d),{},{components:n})):a.createElement(g,r({ref:e},d))}));function h(t,e){var n=arguments,i=e&&e.mdxType;if("string"==typeof t||i){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var l in e)hasOwnProperty.call(e,l)&&(s[l]=e[l]);s.originalType=t,s.mdxType="string"==typeof t?t:i,r[1]=s;for(var c=2;c<o;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},3941:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>l,contentTitle:()=>r,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(7462),i=(n(7294),n(3905));const o={sidebar_position:5,title:"Attestation Crafting"},r=void 0,s={unversionedId:"getting-started/attestation-crafting",id:"getting-started/attestation-crafting",title:"Attestation Crafting",description:"Introduction",source:"@site/docs/getting-started/attestation-crafting.md",sourceDirName:"getting-started",slug:"/getting-started/attestation-crafting",permalink:"/getting-started/attestation-crafting",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{sidebar_position:5,title:"Attestation Crafting"},sidebar:"tutorialSidebar",previous:{title:"Workflow Creation",permalink:"/getting-started/workflow-definition"},next:{title:"Operator View",permalink:"/getting-started/operator-view"}},l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"attestation init",id:"attestation-init",level:4},{value:"attestation add",id:"attestation-add",level:4},{value:"attestation push",id:"attestation-push",level:4},{value:"attestation reset",id:"attestation-reset",level:4},{value:"attestation status",id:"attestation-status",level:4},{value:"Crafting our first attestation locally",id:"crafting-our-first-attestation-locally",level:2},{value:"Initialization",id:"initialization",level:3},{value:"Adding Materials",id:"adding-materials",level:3},{value:"Inspecting the crafting status",id:"inspecting-the-crafting-status",level:3},{value:"Encode, sign and push attestation",id:"encode-sign-and-push-attestation",level:3},{value:"CI integration",id:"ci-integration",level:2}],d={toc:c};function p(t){let{components:e,...n}=t;return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:e,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"In the previous section, we created a workflow definition, a contract and a robot account in the control plane. Next, we'll perform an attestation crafting example using ChainLoop."),(0,i.kt)("p",null,"The lifecycle of a crafting process has the following stages: ",(0,i.kt)("inlineCode",{parentName:"p"},"init"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"add"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"push")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"reset"),". As you can see, it mimics the workflow of a commonly used version control tool, and this is not by coincidence. ChainLoop wants to make sure that the tooling feels familiar to developers and that no security jargon leaks into this stage of the process. For a developer, creating an attestation must be as simple as initializing it, adding materials to it and pushing it."),(0,i.kt)("p",null,"A brief description of the different stages"),(0,i.kt)("h4",{id:"attestation-init"},"attestation init"),(0,i.kt)("p",null,"During this stage, the crafting tool will contact the control plane to "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Signal the intent of starting an attestation."),(0,i.kt)("li",{parentName:"ul"},"Retrieve the associated workflow contract."),(0,i.kt)("li",{parentName:"ul"},"Initialize environment variables explicitly stated in the contract.")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"In the future, during this initialization stage, we will also retrieve ephemeral signing keys for keyless signing/verification")),(0,i.kt)("h4",{id:"attestation-add"},"attestation add"),(0,i.kt)("p",null,"Add the ",(0,i.kt)("strong",{parentName:"p"},"materials required by the contract"),", i.e artifact, OCI image ref, SBOM."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"add")," command knows how to handle each kind of material transparently to the user."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"STRING kinds will be injected as is."),(0,i.kt)("li",{parentName:"ul"},"ARTIFACT kinds will be uploaded to the built-in CAS and referenced by their content digest."),(0,i.kt)("li",{parentName:"ul"},"CONTAINER_IMAGE kinds will be resolved to obtain their repository digests using the local authentication keychain.")),(0,i.kt)("h4",{id:"attestation-push"},"attestation push"),(0,i.kt)("p",null,"This stage will take the current crafting state, validate that it has all the required materials and"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Create a signed, in-toto attestation envelope."),(0,i.kt)("li",{parentName:"ul"},"Push it to the control plane for storage")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Currently, a ",(0,i.kt)("inlineCode",{parentName:"p"},"cosign private key")," needs to be provided during push for signing. In future releases this will not be needed since we will rely on keyless signing and verification.")),(0,i.kt)("h4",{id:"attestation-reset"},"attestation reset"),(0,i.kt)("p",null,"By using the ",(0,i.kt)("inlineCode",{parentName:"p"},"reset")," command we can indicate to the control plane that something went wrong or we want to abort the attestation process."),(0,i.kt)("h4",{id:"attestation-status"},"attestation status"),(0,i.kt)("p",null,"See the state of the current crafting process."),(0,i.kt)("h2",{id:"crafting-our-first-attestation-locally"},"Crafting our first attestation locally"),(0,i.kt)("p",null,"To create an attestation two things are required, the ChainLoop crafting tool and a robot account."),(0,i.kt)("p",null,"The crafting tool is currently bundled within ChainLoop command line tool. To install it just follow the ",(0,i.kt)("a",{parentName:"p",href:"installation"},"installation")," instructions."),(0,i.kt)("p",null,"The robot account was created during the ",(0,i.kt)("a",{parentName:"p",href:"./workflow-definition#robot-account-creation"},"previous step")," and it's required during all the stages of the crafting process. It can be provided via the ",(0,i.kt)("inlineCode",{parentName:"p"},"--token")," flag or the ",(0,i.kt)("inlineCode",{parentName:"p"},"$CHAINLOOP_ROBOT_ACCOUNT")," environment variable."),(0,i.kt)("h3",{id:"initialization"},"Initialization"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ export CHAINLOOP_ROBOT_ACCOUNT=deadbeef\n")),(0,i.kt)("p",null,"To initialize a new crafting process just run ",(0,i.kt)("inlineCode",{parentName:"p"},"attestation init")," and the system will retrieve the latest version (if no specific revision is set via the ",(0,i.kt)("inlineCode",{parentName:"p"},"--revision")," flag) of the contract."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ chainloop attestation init\n\nINF Attestation initialized! now you can check its status or add materials to it\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Initialized At    \u2502 02 Nov 22 10:04 UTC                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Workflow          \u2502 2d289d33-8241-47b7-9ea2-8bd8b7c126f8 \u2502\n\u2502 Name              \u2502 build-and-test                       \u2502\n\u2502 Team              \u2502 cyberdyne core                       \u2502\n\u2502 Project           \u2502 skynet                               \u2502\n\u2502 Contract Revision \u2502 2                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Materials                                                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 NAME                 \u2502 TYPE            \u2502 SET \u2502 REQUIRED \u2502 IS OUTPUT \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 skynet-control-plane \u2502 CONTAINER_IMAGE \u2502 No  \u2502 Yes      \u2502 x         \u2502\n\u2502 rootfs               \u2502 ARTIFACT        \u2502 No  \u2502 Yes      \u2502           \u2502\n\u2502 dockerfile           \u2502 ARTIFACT        \u2502 No  \u2502 No       \u2502           \u2502\n\u2502 commit               \u2502 STRING          \u2502 No  \u2502 Yes      \u2502           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Env Variables                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 GITHUB_REF        \u2502 NOT FOUND \u2502\n\u2502 GITHUB_RUN_ID     \u2502 NOT FOUND \u2502\n\u2502 GITHUB_REPOSITORY \u2502 NOT FOUND \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("p",null,"As you can see, we have some work to do to complete this attestation, we have three required materials not set, let's do that next."),(0,i.kt)("h3",{id:"adding-materials"},"Adding Materials"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"# Add container image\n$ chainloop attestation add --name skynet-control-plane --value  ***.dkr.ecr.us-east-1.amazonaws.com/skynet-control-plane:v0.7.6\nINF material added to attestation\n\n# Add rootfs artifact\n$ chainloop attestation add --name rootfs --value rootfs.tar.gz\nrootfs.tar.gz@sha256:f8a581d4bce57f792444b2230b5706a6f902fbac19a374e76f6a56f030d35cf2 ... done! [7B in 0s; 34B/s]\nINF material added to attestation\n\n# Add commit sha\n$ chainloop attestation add --name commit --value 80e461e9b385c6986cdb8096c9dc99928943d667\nINF material added to attestation\n")),(0,i.kt)("h3",{id:"inspecting-the-crafting-status"},"Inspecting the crafting status"),(0,i.kt)("p",null,"If we check the status of the attestation we'll see that the three required materials have been added."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ chainloop attestation status --full\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Initialized At    \u2502 02 Nov 22 10:04 UTC                  \u2502cosign \n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Workflow          \u2502 2d289d33-8241-47b7-9ea2-8bd8b7c126f8 \u2502\n\u2502 Name              \u2502 build-and-test                       \u2502\n\u2502 Team              \u2502 cyberdyne core                       \u2502\n\u2502 Project           \u2502 skynet                               \u2502\n\u2502 Contract Revision \u2502 2                                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Materials                                                                                                                                                                                                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 NAME                 \u2502 TYPE            \u2502 SET \u2502 REQUIRED \u2502 IS OUTPUT \u2502 VALUE                                                                                                                                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 skynet-control-plane \u2502 CONTAINER_IMAGE \u2502 Yes \u2502 Yes      \u2502 x         \u2502 **.dkr.ecr.us-east-1.amazonaws.com/skynet-control-plane@sha256:963237021c5fd0d31741a9b873e1e8af08c76459cf30e34332925510e0cb3731 \u2502\n\u2502 rootfs               \u2502 ARTIFACT        \u2502 Yes \u2502 Yes      \u2502           \u2502 rootfs.tar.gz@sha256:f8a581d4bce57f792444b2230b5706a6f902fbac19a374e76f6a56f030d35cf2                                                        \u2502\n\u2502 dockerfile           \u2502 ARTIFACT        \u2502 No  \u2502 No       \u2502           \u2502                                                                                                                                              \u2502\n\u2502 commit               \u2502 STRING          \u2502 Yes \u2502 Yes      \u2502           \u2502 80e461e9b385c6986cdb8096c9dc99928943d667                                                                                                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Env Variables                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 GITHUB_REF        \u2502 NOT FOUND \u2502\n\u2502 GITHUB_RUN_ID     \u2502 NOT FOUND \u2502\n\u2502 GITHUB_REPOSITORY \u2502 NOT FOUND \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n")),(0,i.kt)("h3",{id:"encode-sign-and-push-attestation"},"Encode, sign and push attestation"),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Currently, a ",(0,i.kt)("inlineCode",{parentName:"p"},"cosign private key")," needs to be provided during push for signing. In future releases this will not be needed since we will rely on keyless signing and verification.")),(0,i.kt)("p",null,"Since all the required materials have been attached, a ",(0,i.kt)("strong",{parentName:"p"},"signed in-toto statement can now be generated and sent for storage")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'$ export CHAINLOOP_SIGNING_PASSWORD="private key passphrase"\n$ chainloop attestation push --key cosign-private.key\n')),(0,i.kt)("p",null,"The resulting attestation will be rendered, signed and pushed to the control plane."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'INF Attestation pushed!\n{\n   "payloadType": "application/vnd.in-toto+json",\n   "payload": "eyJfdHlwZSI6Imh0dHBzOi8vaW4tdG90by5pby9TdGF0ZW1lbnQvdjAuMSIsInByZWRpY2F0ZVR5cGUiOiJjaGFpbmxvb3AuZGV2L2F0dGVzdGF0aW9uL3YwLjEiLCJzdWJqZWN0IjpbeyJuYW1lIjoiY2hhaW5sb29wLmRldi93b3JrZmxvdy9idWlsZC1hbmQtdGVzdCIsImRpZ2VzdCI6eyJzaGEyNTYiOiI3ODFkZDExMWQ3NjIzNGMxMmExYzY3NmMxM2ZhZWEwYzQ5NzZmMDRhZGQ4YzhhNzY3MTQxNjQ2ZDIyMzVjNmU4In19LHsibmFtZSI6IjUyOTM0NzEyNjE2NS5ka3IuZWNyLnVzLWVhc3QtMS5hbWF6b25hd3MuY29tL2NoYWlubG9vcC1jb250cm9sLXBsYW5lIiwiZGlnZXN0Ijp****",\n   "signatures": [\n      {\n         "keyid": "",\n         "sig": "MEUCIGtMsHEwJr9oN4PcE/X9cE84BFnGM3WuQ4bXXAc/15VPAiEAqpScGVSINSmJoida/FNWKnYt64xcSE3sEcMkJwFv/H0="\n      }\n   ]\n}\n\n')),(0,i.kt)("h2",{id:"ci-integration"},"CI integration"),(0,i.kt)("p",null,"Native CI/CD runner integrations are under development but the process stated above can be implemented in any CI pipeline."),(0,i.kt)("p",null,"See below an example of Chainloop integrated with a Github Action release job that leverages ",(0,i.kt)("a",{parentName:"p",href:"https://goreleaser.com/"},"goreleaser")," for building container images and binaries and AWS ECR for storage."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml",metastring:'title=".github/workflows/release.yaml"',title:'".github/workflows/release.yaml"'},'name: Release\non:\n  push:\n    tags:\n      - "v*.*.*"\njobs:\n  release:\n    env:\n      CL_VERSION: 0.7.73\n      CHAINLOOP_ROBOT_ACCOUNT: ${{ secrets.CHAINLOOP_WF_RELEASE }}\n    name: "Release CLI and container images"\n    runs-on: ubuntu-latest\n    permissions:\n      id-token: write # required to use OIDC and retrieve AWS credentials\n      contents: write # required for goreleaser\n    steps:\n      # Cosign is required to verify the ChainLoop binary\n      - name: Install Cosign\n        uses: sigstore/cosign-installer@v2.5.0\n\n      # highlight-start\n      - name: Install ChainLoop\n        run: |\n          curl -sfL https://chainloop.dev/install.sh | bash -s -- --version v${{ env.CL_VERSION }}\n          sudo install chainloop /usr/local/bin\n          chainloop version\n      # highlight-end\n\n      - name: Checkout\n        uses: actions/checkout@v3\n        with:\n          fetch-depth: 0\n\n      # highlight-start\n      - name: Initialize Attestation\n        run: |\n          chainloop attestation init --contract-revision 1\n      # highlight-end\n\n      - name: Set up Go\n        uses: actions/setup-go@v3\n        with:\n          go-version: \'1.19\' \n\n      - name: Configure AWS credentials to push container images\n        uses: aws-actions/configure-aws-credentials@v1\n        with:\n          role-to-assume: arn:aws:iam::[REDACTED]\n          aws-region: us-east-1\n\n      - name: Login to Amazon ECR\n        uses: aws-actions/amazon-ecr-login@v1\n\n      - name: Write Cosign key\n        run: echo "$COSIGN_KEY" > /tmp/cosign.key\n        env:\n          COSIGN_KEY: ${{ secrets.COSIGN_KEY }}\n\n      - name: Run GoReleaser\n        id: release\n        uses: goreleaser/goreleaser-action@v3\n        with:\n          distribution: goreleaser\n          version: latest\n          args: release --rm-dist\n        env:\n          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n\n      # highlight-start\n      - name: Add Attestation Artifacts\n        run: |\n          # Add binaries created by goreleaser\n          chainloop attestation add --name [binary-name] --value [binary-path]\n\n          # Created container image\n          chainloop attestation add --name control-plane-image --value ****.dkr.ecr.us-east-1.amazonaws.com/container-image:${{ github.ref_name }}\n\n          # This is just an example of adding a key/val material type\n          # Alternatively, GITHUB_SHA could have been added to the contract env variables allowList\n          chainloop attestation add --name commit --value ${GITHUB_SHA}\n\n      - name: Finish and Record Attestation\n        if: ${{ success() }}\n        run: |\n          chainloop attestation status --full\n          chainloop attestation push --key /tmp/cosign.key\n        env:\n          CHAINLOOP_SIGNING_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}\n\n      - name: Mark attestation as failed\n        if: ${{ failure() }}\n        run: |\n          chainloop attestation reset\n\n      - name: Mark attestation as cancelled\n        if: ${{ cancelled() }}\n        run: |\n          chainloop attestation reset --trigger cancellation\n      # highlight-end\n')))}p.isMDXComponent=!0}}]);